# 服务层核心约束文档

## 🎯 核心服务约束

### 学习数据统计服务 (learning_data.py)

#### 连续学习天数计算
**核心规则**:
- 基于有效打卡的连续天数统计
- 中断一天则重新开始计算
- 系统每日凌晨0:10分批量更新所有用户连续天数

**有效打卡定义**:
- 打开小程序 + 查看至少一个任务详情页面
- 打开小程序 + 查看至少一篇收藏资料  
- 打开小程序 + 完成一次复盘操作
- 每自然日只能打卡一次，重复操作不累计

#### 积分系统计算
**积分获得规则**:
- 基础积分：每次有效作业提交 +1分
- 质量加分：获得"优秀"评价 +2分，获得"极佳"评价 +5分
- 连续打卡奖励：连续3天 +1分，连续7天 +3分，连续15天 +10分
- 复盘完成：每完成一次复盘 +1分

**排行榜设计**:
- 月度积分排行榜：显示当月积分和排名，每月1日重置
- 季度积分排行榜：国考季专属(10-12月)，累计三个月积分
- 个人排名突出显示，显示与上名差距

#### GitHub风格打卡图
**14天方格图设计**:
- 2行×7天布局显示学习活跃度
- 第1行显示第2周（7天前-14天前）
- 第2行显示第1周（今天-6天前）
- 有打卡日期显示绿色，无打卡显示浅灰色

### 复盘管理服务 (review_service.py)

#### 个性化复盘周期
**三种复盘模式**:
- 短周期：1-2-4-8-16天（适合基础薄弱学生）
- 中周期：1-3-7-15-30天（标准推荐，默认选中）
- 长周期：2-5-12-25-50天（适合基础较好学生）

#### 复盘执行逻辑  
- 设置变更后，系统重新计算所有未完成复盘的时间安排
- 优先显示今日需复盘的任务，过期任务标红显示
- 连续完成5次复盘后，任务进入"已掌握"状态

### 任务状态管理服务 (task_status.py)

#### 状态计算引擎
**集中计算显示逻辑**:
- 前端优先使用后端计算结果
- 统一的状态转换规则
- 向后兼容新老数据格式

## 🔧 技术约束

### 数据一致性
- 所有统计数据仅计算付费学员
- 试用用户数据独立存储，不影响教学统计
- 数据更新实时性要求：积分计算<500ms，排行榜更新<1s

### 性能要求
- 学习数据查询平均响应时间 < 200ms
- 批量更新连续天数操作 < 5s
- 排行榜分页查询支持1000+用户

### 缓存策略
- 排行榜数据缓存5分钟
- 个人学习统计缓存1分钟  
- GitHub打卡图缓存1小时

## 📊 关键算法

### 连续天数算法
```python
def calculate_streak(user_id: int) -> int:
    # 从最近的打卡记录开始倒推
    # 遇到中断日期立即停止计算
    # 返回连续天数
```

### 积分排行算法
```python  
def update_leaderboard():
    # 按积分降序排列
    # 相同积分按连续天数排序
    # 月度/季度分别计算
```

## ⚠️ 重要提醒
1. **数据准确性**: 积分和天数计算必须精确无误
2. **权限隔离**: 付费和试用用户数据严格分离
3. **性能监控**: 定期检查统计服务性能指标  
4. **容错处理**: 计算异常时提供降级方案