<!-- æ‰¹æ”¹å†å²æ—¶é—´çº¿ç»„ä»¶ -->
<view class="grading-history-container" wx:if="{{show}}">
  
  <!-- å¤´éƒ¨ä¿¡æ¯ -->
  <view class="history-header">
    <view class="header-title">
      <text class="title-text">æ‰¹æ”¹å†å²</text>
      <text class="subtitle-text">{{studentName || 'å­¦ç”Ÿ'}}çš„ä½œä¸šæ‰¹æ”¹è®°å½•</text>
    </view>
    <view class="close-btn" bindtap="close">
      <text class="close-icon">âœ•</text>
    </view>
  </view>

  <!-- ç»Ÿè®¡ä¿¡æ¯å¡ç‰‡ -->
  <view class="stats-card">
    <view class="stat-item">
      <text class="stat-number">{{historyData.totalSubmissions || 0}}</text>
      <text class="stat-label">æ€»æäº¤æ¬¡æ•°</text>
    </view>
    <view class="stat-divider"></view>
    <view class="stat-item">
      <text class="stat-number">{{historyData.gradedCount || 0}}</text>
      <text class="stat-label">å·²æ‰¹æ”¹æ¬¡æ•°</text>
    </view>
    <view class="stat-divider"></view>
    <view class="stat-item">
      <text class="stat-number">{{historyData.avgScore || '--'}}</text>
      <text class="stat-label">å¹³å‡å¾—åˆ†</text>
    </view>
  </view>

  <!-- æ—¶é—´çº¿å†…å®¹ -->
  <scroll-view class="timeline-container" scroll-y>
    
    <!-- åŠ è½½çŠ¶æ€ -->
    <view wx:if="{{loading}}" class="loading-container">
      <text class="loading-text">åŠ è½½ä¸­...</text>
    </view>

    <!-- æ—¶é—´çº¿åˆ—è¡¨ -->
    <view wx:else class="timeline-list">
      <view 
        wx:for="{{timelineItems}}" 
        wx:key="id" 
        class="timeline-item {{item.type}}"
      >
        <!-- æ—¶é—´çº¿ç‚¹ -->
        <view class="timeline-dot {{item.type}}">
          <text class="dot-icon">{{item.icon}}</text>
        </view>
        
        <!-- æ—¶é—´çº¿å†…å®¹ -->
        <view class="timeline-content">
          <!-- æ—¶é—´æ ‡ç­¾ -->
          <view class="timeline-time">{{item.timeText}}</view>
          
          <!-- æäº¤è®°å½• -->
          <view wx:if="{{item.type === 'submission'}}" class="submission-record">
            <view class="record-header">
              <text class="record-title">ç¬¬{{item.attemptNumber}}æ¬¡æäº¤</text>
              <text class="record-status {{item.status}}">{{item.statusText}}</text>
            </view>
            
            <!-- ä½œä¸šå†…å®¹é¢„è§ˆ -->
            <view wx:if="{{item.hasContent}}" class="content-preview">
              <view wx:if="{{item.images && item.images.length > 0}}" class="preview-images">
                <image 
                  wx:for="{{item.images}}" 
                  wx:key="index" 
                  wx:for-item="img"
                  src="{{img}}" 
                  mode="aspectFill"
                  class="preview-thumb"
                  bindtap="previewImage"
                  data-url="{{img}}"
                  lazy-load="true"
                />
                <view wx:if="{{item.images.length > 3}}" class="more-images">
                  +{{item.images.length - 3}}
                </view>
              </view>
              
              <view wx:if="{{item.text}}" class="preview-text">
                <text>{{item.text}}</text>
              </view>
            </view>
          </view>
          
          <!-- æ‰¹æ”¹è®°å½• -->
          <view wx:elif="{{item.type === 'grading'}}" class="grading-record">
            <view class="record-header">
              <text class="record-title">æ‰¹æ”¹è¯„ä»·</text>
              <view class="grade-badge {{item.grade}}">{{item.gradeText}}</view>
            </view>
            
            <!-- æ‰¹æ”¹è¯¦æƒ… -->
            <view class="grading-details">
              <!-- å¾—åˆ† -->
              <view wx:if="{{item.score}}" class="score-info">
                <text class="score-label">å¾—åˆ†ï¼š</text>
                <text class="score-value">{{item.score}}</text>
                <text class="score-total">/{{item.totalScore || 100}}</text>
              </view>
              
              <!-- è¯„è¯­ -->
              <view wx:if="{{item.feedback}}" class="feedback-content">
                <text class="feedback-label">è¯„è¯­ï¼š</text>
                <text class="feedback-text">{{item.feedback}}</text>
              </view>
              
              <!-- æ‰¹æ”¹ä¿¡æ¯ -->
              <view class="grading-info">
                <text class="grader-name">æ‰¹æ”¹è€å¸ˆï¼š{{item.graderName || 'ç³»ç»Ÿ'}}</text>
                <text class="grading-duration" wx:if="{{item.gradingDuration}}">
                  è€—æ—¶ï¼š{{item.gradingDurationText}}
                </text>
              </view>
            </view>
          </view>
          
          <!-- ç³»ç»Ÿäº‹ä»¶ -->
          <view wx:elif="{{item.type === 'system'}}" class="system-record">
            <view class="record-header">
              <text class="record-title">{{item.title}}</text>
              <text class="system-tag">ç³»ç»Ÿ</text>
            </view>
            <view wx:if="{{item.description}}" class="system-description">
              <text>{{item.description}}</text>
            </view>
          </view>
        </view>
        
        <!-- è¿æ¥çº¿ -->
        <view wx:if="{{index < timelineItems.length - 1}}" class="timeline-connector"></view>
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view wx:if="{{!loading && timelineItems.length === 0}}" class="empty-state">
      <text class="empty-icon">ğŸ“‹</text>
      <text class="empty-text">æš‚æ— æ‰¹æ”¹å†å²è®°å½•</text>
    </view>
  </scroll-view>

  <!-- åº•éƒ¨æ“ä½œæŒ‰é’® -->
  <view class="action-footer">
    <button class="action-btn secondary" bindtap="exportHistory" wx:if="{{allowExport}}">
      å¯¼å‡ºè®°å½•
    </button>
    <button class="action-btn primary" bindtap="close">
      å…³é—­
    </button>
  </view>
</view>

<!-- èƒŒæ™¯é®ç½© -->
<view class="history-mask" wx:if="{{show}}" bindtap="close"></view>