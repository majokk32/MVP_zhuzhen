<!-- 学生管理页面 -->
<view class="container">
  <!-- 头部统计 -->
  <view class="stats-header">
    <view class="header-title">
      <text class="title-icon">👥</text>
      <text class="title-text">学生管理</text>
    </view>
    <view class="stats-grid">
      <view class="stat-item">
        <view class="stat-number">{{totalStudents}}</view>
        <view class="stat-label">总学员</view>
      </view>
      <view class="stat-item">
        <view class="stat-number paid">{{paidStudents}}</view>
        <view class="stat-label">付费</view>
      </view>
      <view class="stat-item">
        <view class="stat-number trial">{{trialStudents}}</view>
        <view class="stat-label">试用</view>
      </view>
    </view>
  </view>

  <!-- 筛选按钮 -->
  <view class="filter-buttons">
    <view class="filter-btn-group">
      <button 
        class="filter-btn {{currentFilter === 'all' ? 'active' : ''}}"
        data-filter="all"
        bindtap="onFilterChange"
      >
        <text class="filter-icon">📋</text>全部
      </button>
      <button 
        class="filter-btn {{currentFilter === 'paid' ? 'active' : ''}}"
        data-filter="paid"
        bindtap="onFilterChange"
      >
        <text class="filter-icon">✅</text>付费
      </button>
      <button 
        class="filter-btn {{currentFilter === 'trial' ? 'active' : ''}}"
        data-filter="trial"
        bindtap="onFilterChange"
      >
        <text class="filter-icon">❌</text>试用
      </button>
    </view>
  </view>

  <!-- 搜索框 -->
  <view class="search-section">
    <view class="search-wrapper">
      <text class="search-icon">🔍</text>
      <input 
        class="search-input" 
        placeholder="搜索学生姓名或手机号"
        value="{{searchKeyword}}"
        bindinput="onSearchInput"
        bindconfirm="onSearchConfirm"
      />
      <view wx:if="{{searchKeyword}}" class="search-clear" bindtap="onSearchClear">
        <text class="clear-icon">×</text>
      </view>
    </view>
  </view>

  <!-- 学生列表 -->
  <scroll-view 
    class="student-list"
    scroll-y
    enable-back-to-top
    refresher-enabled
    refresher-triggered="{{refreshing}}"
    bindrefresherrefresh="onRefresh"
    bindscrolltolower="onLoadMore"
  >
    <!-- 学生卡片 -->
    <view wx:for="{{studentList}}" wx:key="id" class="student-card" data-student="{{item}}">
      <view class="student-main-info">
        <view class="student-avatar-section">
          <!-- 头像 -->
          <view class="avatar-container">
            <image 
              class="student-avatar" 
              src="{{item.avatar}}" 
              mode="aspectFill" 
              wx:if="{{item.avatar && item.avatar !== 'https://example.com/default_avatar.jpg'}}"
              lazy-load="true" 
              binderror="onImageError"
            />
            <view class="avatar-placeholder" wx:else>
              <text class="avatar-icon">👤</text>
            </view>
            <!-- 在线状态指示器 -->
            <view class="status-indicator {{item.permission_type === 'paid' ? 'online' : 'offline'}}"></view>
          </view>
          
          <!-- 学生信息 -->
          <view class="student-info">
            <view class="student-name">{{item.nickname || '未设置昵称'}}</view>
            <view class="student-stats-text">
              总提交：{{item.stats.total_submissions || 0}}次 | 最后登录：{{item.last_active}}
            </view>
          </view>
        </view>

        <!-- 状态和操作 -->
        <view class="student-actions">
          <view class="permission-status {{item.permission_type === 'paid' ? 'authorized' : 'unauthorized'}}">
            {{item.permission_type === 'paid' ? '付费' : '试用'}}
          </view>
          <button class="archive-btn {{item.permission_type === 'paid' ? 'active' : 'inactive'}}" bindtap="viewStudentArchive" data-student="{{item}}">
            档案
          </button>
        </view>
      </view>
    </view>

    <!-- 加载更多 -->
    <view wx:if="{{loadingMore}}" class="loading-more">
      <view class="loading-spinner"></view>
      <text class="loading-text">加载中...</text>
    </view>

    <!-- 没有更多 -->
    <view wx:if="{{!hasMore && studentList.length > 0}}" class="no-more">
      <text class="no-more-text">- 没有更多了 -</text>
    </view>

    <!-- 空状态 -->
    <empty-state
      show="{{isEmpty && !loading}}"
      icon="👥"
      title="{{getEmptyText()}}"
      description="{{getEmptyHint()}}"
      show-action="{{currentFilter === 'all'}}"
      action-text="刷新数据"
      action-type="outline"
      bind:actionClick="onRefresh"
    ></empty-state>

    <!-- 骨架屏 -->
    <skeleton show="{{loading && studentList.length === 0}}" type="student-list" count="{{4}}"></skeleton>
  </scroll-view>

  <!-- 浮动操作按钮 -->
  <view class="fab-actions">
    <view class="fab-btn" bindtap="exportStudentList">
      <text class="fab-icon">📤</text>
      <text class="fab-text">导出</text>
    </view>
  </view>
</view>

<!-- 底部安全区域 -->
<view class="safe-bottom"></view>