<!-- pages/subscription/subscription.wxml -->
<view class="subscription-page">
  <!-- å¤´éƒ¨çŠ¶æ€ -->
  <view class="subscription-header">
    <view class="current-status">
      <text class="status-title">å½“å‰è®¢é˜…çŠ¶æ€</text>
      <view class="status-info">
        <text class="status-text status-{{subscriptionStatus}}">
          {{getSubscriptionStatusText()}}
        </text>
        <view wx:if="{{currentSubscription && !remainingTime.expired}}" class="subscription-details">
          <text class="plan-name">{{currentSubscription.plan.name}}</text>
          <text class="auto-renew-status" wx:if="{{autoRenewEnabled}}">è‡ªåŠ¨ç»­è´¹å·²å¼€å¯</text>
        </view>
      </view>
    </view>
    
    <!-- è‡ªåŠ¨ç»­è´¹ç®¡ç† -->
    <view wx:if="{{currentSubscription && subscriptionStatus === 'active'}}" class="auto-renew-section">
      <view class="auto-renew-toggle">
        <text class="toggle-label">è‡ªåŠ¨ç»­è´¹</text>
        <switch 
          checked="{{autoRenewEnabled}}" 
          bindchange="toggleAutoRenew"
          color="#1989fa"
        />
      </view>
      <button 
        wx:if="{{autoRenewEnabled}}" 
        class="cancel-auto-renew-btn" 
        bindtap="cancelAutoRenewal"
        size="mini"
      >
        å–æ¶ˆè‡ªåŠ¨ç»­è´¹
      </button>
    </view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading-container">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  <!-- è®¢é˜…è®¡åˆ’åˆ—è¡¨ -->
  <view wx:else class="subscription-plans">
    <view class="plans-header">
      <text class="plans-title">é€‰æ‹©è®¢é˜…è®¡åˆ’</text>
      <view class="feature-comparison-toggle" bindtap="toggleFeatureComparison">
        <text class="toggle-text">åŠŸèƒ½å¯¹æ¯”</text>
        <text class="toggle-icon">{{showFeatureComparison ? 'â–¼' : 'â–¶'}}</text>
      </view>
    </view>

    <!-- åŠŸèƒ½å¯¹æ¯”è¡¨ -->
    <view wx:if="{{showFeatureComparison}}" class="feature-comparison">
      <view class="comparison-header">
        <text class="feature-label">åŠŸèƒ½</text>
        <text class="plan-header">æœˆåº¦</text>
        <text class="plan-header">å­£åº¦</text>
        <text class="plan-header">å¹´åº¦</text>
      </view>
      <view class="comparison-row" wx:for="{{['åŸºç¡€åŠŸèƒ½', 'æ•°æ®å¯¼å‡º', 'é«˜çº§åˆ†æ', 'ä¼˜å…ˆå®¢æœ', 'ä¸“å±è®¡åˆ’']}}" wx:key="*this">
        <text class="feature-name">{{item}}</text>
        <text class="feature-status">âœ“</text>
        <text class="feature-status">âœ“</text>
        <text class="feature-status">âœ“</text>
      </view>
    </view>

    <!-- è®¡åˆ’å¡ç‰‡ -->
    <view class="plans-list">
      <view 
        class="{{getPlanClassName(item.id)}}"
        wx:for="{{subscriptionPlans}}" 
        wx:key="id"
        data-plan-id="{{item.id}}"
        bindtap="selectPlan"
      >
        <!-- æ¨èæ ‡ç­¾ -->
        <view wx:if="{{item.id === 'quarterly'}}" class="recommended-badge">
          <text class="badge-text">{{item.discount}}</text>
        </view>
        
        <!-- è®¡åˆ’ä¿¡æ¯ -->
        <view class="plan-header">
          <text class="plan-name">{{item.name}}</text>
          <view class="plan-pricing">
            <text class="current-price">Â¥{{item.price}}</text>
            <text class="original-price">Â¥{{item.originalPrice}}</text>
          </view>
          <text class="plan-duration">{{item.duration}}å¤©æœ‰æ•ˆæœŸ</text>
        </view>

        <!-- åŠŸèƒ½åˆ—è¡¨ -->
        <view class="plan-features">
          <view class="feature-item" wx:for="{{item.features}}" wx:key="*this" wx:for-item="feature">
            <text class="feature-icon">âœ“</text>
            <text class="feature-text">{{feature}}</text>
          </view>
        </view>

        <!-- é€‰æ‹©æŒ‡ç¤ºå™¨ -->
        <view class="selection-indicator">
          <text class="indicator-icon">{{selectedPlanId === item.id ? 'âœ“' : 'â—‹'}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- ä¼˜æƒ åˆ¸åŒºåŸŸ -->
  <view class="coupon-section">
    <view class="coupon-toggle" bindtap="toggleCouponInput">
      <text class="coupon-text">ä½¿ç”¨ä¼˜æƒ åˆ¸</text>
      <text class="coupon-icon">{{showCouponInput ? 'â–¼' : 'â–¶'}}</text>
    </view>
    
    <view wx:if="{{showCouponInput}}" class="coupon-input-area">
      <input 
        class="coupon-input"
        type="text"
        placeholder="è¯·è¾“å…¥ä¼˜æƒ åˆ¸ä»£ç "
        value="{{couponCode}}"
        bindinput="onCouponInput"
      />
      <button 
        class="apply-coupon-btn"
        bindtap="applyCoupon"
        size="mini"
      >
        åº”ç”¨
      </button>
    </view>

    <!-- ä¼˜æƒ åˆ¸ç”Ÿæ•ˆæç¤º -->
    <view wx:if="{{couponDiscount}}" class="coupon-success">
      <text class="success-icon">âœ“</text>
      <text class="success-text">ä¼˜æƒ åˆ¸å·²ç”Ÿæ•ˆï¼Œå‡å…Â¥{{couponDiscount.amount}}</text>
    </view>
  </view>

  <!-- æ”¯ä»˜æŒ‰é’® -->
  <view class="payment-section">
    <view class="payment-summary">
      <view class="selected-plan-info">
        <text class="summary-title">{{subscriptionPlans.find(p => p.id === selectedPlanId)?.name}}</text>
        <view class="price-breakdown">
          <text class="final-price">
            Â¥{{calculateDiscountedPrice(subscriptionPlans.find(p => p.id === selectedPlanId)?.price || 0)}}
          </text>
          <text wx:if="{{couponDiscount}}" class="original-amount">
            åŸä»·Â¥{{subscriptionPlans.find(p => p.id === selectedPlanId)?.price}}
          </text>
        </view>
      </view>
      
      <view class="auto-renew-notice" wx:if="{{autoRenewEnabled}}">
        <text class="notice-icon">â“˜</text>
        <text class="notice-text">å¼€å¯è‡ªåŠ¨ç»­è´¹ï¼Œåˆ°æœŸè‡ªåŠ¨ç»­è®¢</text>
      </view>
    </view>

    <!-- æ”¯ä»˜æŒ‰é’®åŒºåŸŸ -->
    <view class="payment-buttons">
      <button 
        class="purchase-btn"
        bindtap="purchaseSubscription"
        loading="{{loadingPayment}}"
        disabled="{{loadingPayment}}"
      >
        {{loadingPayment ? 'æ”¯ä»˜ä¸­...' : 'ç«‹å³è®¢é˜…'}}
      </button>
      
      <button 
        wx:if="{{subscriptionStatus === 'expired'}}"
        class="reactivate-btn"
        bindtap="reactivateSubscription"
      >
        é‡æ–°æ¿€æ´»
      </button>
    </view>
  </view>

  <!-- æ”¯ä»˜å†å² -->
  <view class="payment-history-section">
    <view class="history-header" bindtap="togglePaymentHistory">
      <text class="history-title">æ”¯ä»˜å†å²</text>
      <text class="history-toggle">{{showPaymentHistory ? 'â–¼' : 'â–¶'}}</text>
    </view>
    
    <view wx:if="{{showPaymentHistory}}" class="payment-history-list">
      <view 
        wx:if="{{paymentHistory.length === 0}}" 
        class="empty-history"
      >
        <text class="empty-text">æš‚æ— æ”¯ä»˜è®°å½•</text>
      </view>
      
      <view 
        class="payment-item"
        wx:for="{{paymentHistory}}" 
        wx:key="id"
        data-payment-id="{{item.id}}"
        bindtap="viewPaymentDetail"
      >
        <view class="payment-info">
          <text class="payment-plan">{{item.plan.name}}</text>
          <text class="payment-date">{{new Date(item.created_at).toLocaleDateString()}}</text>
        </view>
        <view class="payment-amount">
          <text class="amount-text">Â¥{{item.amount/100}}</text>
          <text class="status-badge status-{{item.status}}">{{item.status}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- å¸®åŠ©ä¸æ”¯æŒ -->
  <view class="support-section">
    <view class="support-item" bindtap="contactSupport">
      <text class="support-icon">ğŸ“</text>
      <text class="support-text">è”ç³»å®¢æœ</text>
      <text class="support-detail">400-123-4567</text>
    </view>
    
    <view class="terms-link">
      <text class="terms-text">è®¢é˜…å³è¡¨ç¤ºåŒæ„</text>
      <text class="terms-link-text">ã€ŠæœåŠ¡æ¡æ¬¾ã€‹</text>
      <text class="terms-text">å’Œ</text>
      <text class="terms-link-text">ã€Šéšç§æ”¿ç­–ã€‹</text>
    </view>
  </view>
</view>