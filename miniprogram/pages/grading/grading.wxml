<!-- æ‰¹æ”¹é¡µé¢ -->
<view class="container">
  <!-- é¡¶éƒ¨ä»»åŠ¡ä¿¡æ¯ -->
  <view class="task-header">
    <view class="task-title">{{task.title}}</view>
    <view class="task-stats">
      <view class="stat-item">
        <text class="stat-label">å¾…æ‰¹æ”¹</text>
        <text class="stat-value">{{pendingCount}}</text>
      </view>
      <view class="stat-item">
        <text class="stat-label">å·²æ‰¹æ”¹</text>
        <text class="stat-value">{{reviewedCount}}</text>
      </view>
    </view>
  </view>

  <!-- æ‰¹æ”¹åˆ—è¡¨æˆ–æ‰¹æ”¹è¯¦æƒ… -->
  <view wx:if="{{!currentSubmission}}" class="submission-list">
    
    <!-- éª¨æ¶å±åŠ è½½çŠ¶æ€ -->
    <skeleton show="{{loading}}" type="student-list" count="{{5}}"></skeleton>
    
    <!-- å®é™…å†…å®¹ -->
    <view wx:if="{{!loading}}">
    <!-- ç­›é€‰æ  -->
    <view class="filter-bar">
      <view class="filter-tabs">
        <view 
          class="filter-tab {{filterStatus === 'all' ? 'active' : ''}}"
          bindtap="onFilterChange"
          data-status="all"
        >
          å…¨éƒ¨
        </view>
        <view 
          class="filter-tab {{filterStatus === 'pending' ? 'active' : ''}}"
          bindtap="onFilterChange"
          data-status="pending"
        >
          å¾…æ‰¹æ”¹
        </view>
        <view 
          class="filter-tab {{filterStatus === 'reviewed' ? 'active' : ''}}"
          bindtap="onFilterChange"
          data-status="reviewed"
        >
          å·²æ‰¹æ”¹
        </view>
      </view>
    </view>

    <!-- æäº¤åˆ—è¡¨ -->
    <view class="submissions">
      <view 
        wx:for="{{submissions}}" 
        wx:key="id"
        class="submission-item"
        bindtap="selectSubmission"
        data-index="{{index}}"
      >
        <view class="student-info">
          <image class="student-avatar" src="{{item.user.avatar}}" mode="aspectFill" wx:if="{{item.user.avatar}}" lazy-load="true" binderror="onImageError"/>
          <view class="student-avatar avatar-placeholder" wx:else>
            <text>ğŸ‘¤</text>
          </view>
          <view class="student-detail">
            <text class="student-name">{{item.user.nickname || 'å­¦ç”Ÿ'}}</text>
            <text class="submit-time">{{item.submitted_at}}</text>
          </view>
        </view>
        
        <view class="submission-status">
          <view wx:if="{{item.status === 'pending'}}" class="status-badge pending">å¾…æ‰¹æ”¹</view>
          <view wx:elif="{{item.grade}}" class="grade-badge {{item.grade}}">
            {{item.gradeText}}
          </view>
        </view>
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view wx:if="{{submissions.length === 0}}" class="empty-state">
      <text class="empty-icon">ğŸ“¦</text>
      <text>æš‚æ— æäº¤çš„ä½œä¸š</text>
    </view>
    
    </view> <!-- ç»“æŸå®é™…å†…å®¹ -->
  </view>

  <!-- æ‰¹æ”¹è¯¦æƒ…è§†å›¾ -->
  <view wx:else class="grading-detail">
    <!-- æ‰¹æ”¹è¯¦æƒ…åŠ è½½çŠ¶æ€ -->
    <skeleton show="{{loadingSubmission}}" type="grading-detail" />
    
    <!-- æ‰¹æ”¹å†…å®¹ -->
    <view wx:if="{{!loadingSubmission}}">
    <!-- å­¦ç”Ÿä¿¡æ¯æ  -->
    <view class="student-bar">
      <view class="student-info">
        <image class="student-avatar" src="{{currentSubmission.user.avatar}}" mode="aspectFill" wx:if="{{currentSubmission.user.avatar}}" lazy-load="true" binderror="onImageError"/>
        <view class="student-avatar avatar-placeholder" wx:else>
          <text>ğŸ‘¤</text>
        </view>
        <view class="student-detail">
          <text class="student-name">{{currentSubmission.user.nickname || 'å­¦ç”Ÿ'}}</text>
          <text class="submit-info">ç¬¬{{currentSubmission.attemptNumber}}æ¬¡æäº¤ Â· {{currentSubmission.submitted_at}}</text>
        </view>
      </view>
      
      <!-- ä½¿ç”¨æ–°çš„å¯¼èˆªç»„ä»¶ -->
      <grading-navigator
        currentIndex="{{currentIndex}}"
        totalCount="{{submissions.length}}"
        submissionList="{{submissions}}"
        currentStudent="{{currentSubmission.user}}"
        taskInfo="{{task}}"
        gradingStats="{{gradingStats}}"
        showSmartNav="{{true}}"
        showEfficiency="{{true}}"
        bind:navigate="onNavigatorNavigate"
        bind:action="onNavigatorAction"
      />
    </view>

    <!-- ä½œä¸šå†…å®¹ -->
    <view class="submission-content">
      <view class="section-title">
        <text class="icon">ğŸ“</text>
        <text>å­¦ç”Ÿæäº¤å†…å®¹</text>
      </view>
      
      <!-- æäº¤ç»Ÿè®¡ä¿¡æ¯ -->
      <view class="submission-meta">
        <view class="meta-item">
          <text class="meta-label">æäº¤æ—¶é—´ï¼š</text>
          <text class="meta-value">{{currentSubmission.submitted_at || 'æœªçŸ¥'}}</text>
        </view>
        <view class="meta-item">
          <text class="meta-label">æäº¤æ¬¡æ•°ï¼š</text>
          <text class="meta-value">ç¬¬{{currentSubmission.attemptNumber || 1}}æ¬¡</text>
        </view>
        <view class="meta-item">
          <text class="meta-label">å†…å®¹ç»Ÿè®¡ï¼š</text>
          <text class="meta-value">
            {{currentSubmission.images && currentSubmission.images.length > 0 ? currentSubmission.images.length + 'å¼ å›¾ç‰‡' : ''}}
            {{currentSubmission.documents && currentSubmission.documents.length > 0 ? (currentSubmission.images && currentSubmission.images.length > 0 ? ' + ' : '') + currentSubmission.documents.length + 'ä¸ªæ–‡æ¡£' : ''}}
            {{currentSubmission.text && currentSubmission.text.trim() ? (currentSubmission.images && currentSubmission.images.length > 0 || currentSubmission.documents && currentSubmission.documents.length > 0 ? ' + ' : '') + 'æ–‡å­—è¯´æ˜' : ''}}
            {{(!currentSubmission.images || currentSubmission.images.length === 0) && (!currentSubmission.documents || currentSubmission.documents.length === 0) && (!currentSubmission.text || !currentSubmission.text.trim()) ? 'æ— å†…å®¹' : ''}}
          </text>
        </view>
      </view>
      
      <!-- å†…å®¹åŒºåŸŸåˆ†å—å±•ç¤º -->
      <view class="submission-content-sections">
        
        <!-- æ–‡å­—å†…å®¹åŒºåŸŸ -->
        <view wx:if="{{currentSubmission.text && currentSubmission.text.trim()}}" class="content-section text-section">
          <view class="content-header">
            <text class="content-icon">ğŸ’¬</text>
            <text class="content-title">æ–‡å­—è¯´æ˜</text>
            <text class="content-count">({{currentSubmission.text.length}}å­—)</text>
          </view>
          <view class="content-text">
            <text user-select="true">{{currentSubmission.text}}</text>
          </view>
        </view>
        
        <!-- å›¾ç‰‡å†…å®¹åŒºåŸŸ -->
        <view wx:if="{{currentSubmission.images && currentSubmission.images.length > 0}}" class="content-section image-section">
          <view class="content-header">
            <text class="content-icon">ğŸ–¼ï¸</text>
            <text class="content-title">æäº¤å›¾ç‰‡</text>
            <text class="content-count">({{currentSubmission.images.length}}å¼ )</text>
          </view>
          <view class="content-images">
            <scroll-view scroll-x class="image-scroll" show-scrollbar="false">
              <view class="image-list">
                <view wx:for="{{currentSubmission.images}}" wx:key="index" class="image-item">
                  <image 
                    src="{{item}}" 
                    mode="aspectFill"
                    class="content-image"
                    bindtap="previewImage"
                    data-url="{{item}}"
                    lazy-load="true"
                    show-menu-by-longpress="false"
                    binderror="onImageError"
                  />
                  <view class="image-index">{{index + 1}}</view>
                </view>
              </view>
            </scroll-view>
          </view>
          
          <!-- å›¾ç‰‡æ“ä½œæç¤º -->
          <view class="image-hint">
            <text>ç‚¹å‡»å›¾ç‰‡å¯æ”¾å¤§æŸ¥çœ‹</text>
          </view>
        </view>
        
        <!-- æ–‡æ¡£å†…å®¹åŒºåŸŸ -->
        <view wx:if="{{currentSubmission.documents && currentSubmission.documents.length > 0}}" class="content-section document-section">
          <view class="content-header">
            <text class="content-icon">ğŸ“„</text>
            <text class="content-title">æäº¤æ–‡æ¡£</text>
            <text class="content-count">({{currentSubmission.documents.length}}ä¸ª)</text>
          </view>
          <view class="content-documents">
            <view wx:for="{{currentSubmission.documents}}" wx:key="index" class="document-item">
              <view class="document-icon">
                <text wx:if="{{item.type === 'pdf'}}">ğŸ“–</text>
                <text wx:elif="{{item.type === 'word'}}">ğŸ“</text>
                <text wx:else>ğŸ“„</text>
              </view>
              <view class="document-info">
                <text class="document-name">{{item.name}}</text>
                <text class="document-type">{{item.type === 'pdf' ? 'PDFæ–‡æ¡£' : item.type === 'word' ? 'Wordæ–‡æ¡£' : 'æ–‡æ¡£æ–‡ä»¶'}}</text>
              </view>
              <view class="document-actions">
                <button class="action-btn download-btn" bindtap="downloadDocument" data-url="{{item.url}}" data-name="{{item.name}}">
                  ä¸‹è½½
                </button>
              </view>
            </view>
          </view>
          
          <!-- æ–‡æ¡£æ“ä½œæç¤º -->
          <view class="document-hint">
            <text>ç‚¹å‡»ä¸‹è½½æŒ‰é’®å¯ä¿å­˜æ–‡æ¡£åˆ°æœ¬åœ°</text>
          </view>
        </view>
        
      </view>

      <!-- ç©ºçŠ¶æ€æç¤º -->
      <view wx:if="{{(!currentSubmission.images || currentSubmission.images.length === 0) && (!currentSubmission.documents || currentSubmission.documents.length === 0) && (!currentSubmission.text || !currentSubmission.text.trim())}}" class="content-section empty-section">
        <view class="empty-content">
          <text class="empty-icon">ğŸ“„</text>
          <text class="empty-text">å­¦ç”Ÿæœªæäº¤ä»»ä½•å†…å®¹</text>
          <text class="empty-hint">è¯·è”ç³»å­¦ç”Ÿé‡æ–°æäº¤ä½œä¸š</text>
        </view>
      </view>
    </view>

    <!-- æ‰¹æ”¹åŒºåŸŸ -->
    <view class="grading-section">
      <view class="section-title">
        <text class="icon">âœï¸</text>
        <text>æ‰¹æ”¹è¯„ä»·</text>
      </view>

      <!-- è¯„åˆ†æ¡£ä½ -->
      <view class="grade-options">
        <view 
          class="grade-option {{gradeData.grade === 'excellent' ? 'selected' : ''}}"
          bindtap="selectGrade"
          data-grade="excellent"
        >
          <view class="grade-icon excellent">ğŸŒŸ</view>
          <text class="grade-name">æä½³</text>
          <text class="grade-desc">å®Œæˆè´¨é‡ä¼˜å¼‚</text>
        </view>
        
        <view 
          class="grade-option {{gradeData.grade === 'good' ? 'selected' : ''}}"
          bindtap="selectGrade"
          data-grade="good"
        >
          <view class="grade-icon good">ğŸ‘</view>
          <text class="grade-name">ä¼˜ç§€</text>
          <text class="grade-desc">å®Œæˆè´¨é‡è‰¯å¥½</text>
        </view>
        
        <view 
          class="grade-option {{gradeData.grade === 'review' ? 'selected' : ''}}"
          bindtap="selectGrade"
          data-grade="review"
        >
          <view class="grade-icon review">ğŸ“š</view>
          <text class="grade-name">å¾…å¤ç›˜</text>
          <text class="grade-desc">éœ€è¦æ”¹è¿›</text>
        </view>
      </view>

      <!-- åˆ†æ•°è¾“å…¥ -->
      <view class="score-input-area">
        <view class="input-label">å¾—åˆ†ï¼ˆé€‰å¡«ï¼‰</view>
        <view class="score-input-wrapper">
          <input 
            type="number"
            class="score-input"
            placeholder="è¯·è¾“å…¥åˆ†æ•°"
            value="{{gradeData.score}}"
            bindinput="onScoreInput"
          />
          <text class="score-total">/ {{task.total_score || 100}}</text>
        </view>
      </view>

      <!-- æ··åˆè¾“å…¥è¯„è¯­åŒºåŸŸ -->
      <view class="feedback-input-section">
        <view class="input-label">æ‰¹æ”¹è¯„è¯­ï¼ˆé€‰å¡«ï¼‰</view>
        <mixed-input 
          placeholder="è¯·è¾“å…¥æ‰¹æ”¹è¯„è¯­ï¼ˆé€‰å¡«ï¼‰ï¼Œç»™å­¦ç”Ÿä¸€äº›å»ºè®®å’Œé¼“åŠ±..."
          maxLength="500"
          value="{{gradeData.feedback}}"
          bind:input="onMixedInput"
          bind:confirm="onFeedbackConfirm"
          bind:transcriptionComplete="onTranscriptionComplete"
          showQuickActions="{{true}}"
          showClearBtn="{{true}}"
        />
      </view>

      <!-- å¿«æ·è¯„è¯­ï¼ˆä¿ç•™ä½œä¸ºè¡¥å……ï¼‰ -->
      <view class="quick-feedback" wx:if="{{quickFeedbacks.length > 0}}">
        <view class="quick-title">å¸¸ç”¨è¯„è¯­æ¨¡æ¿</view>
        <scroll-view scroll-x class="quick-list">
          <view class="quick-items">
            <view 
              wx:for="{{quickFeedbacks}}" 
              wx:key="index"
              class="quick-item"
              bindtap="useQuickFeedback"
              data-text="{{item}}"
            >
              {{item}}
            </view>
          </view>
        </scroll-view>
      </view>

      <!-- æ“ä½œæŒ‰é’® -->
      <view class="action-buttons">
        <button class="btn-secondary" bindtap="cancelGrading">å–æ¶ˆ</button>
        <button 
          class="btn-primary {{canSubmitGrade ? '' : 'disabled'}}"
          disabled="{{!canSubmitGrade || isSubmitting}}"
          bindtap="submitGrade"
        >
          {{isSubmitting ? 'æäº¤ä¸­...' : 'æäº¤æ‰¹æ”¹'}}
        </button>
      </view>
    </view>
    </view> <!-- ç»“æŸæ‰¹æ”¹å†…å®¹ -->
  </view>

  <!-- æ‰¹é‡æ“ä½œæµ®åŠ¨æŒ‰é’® -->
  <view wx:if="{{!currentSubmission && isTeacher}}" class="float-actions">
    <view class="float-btn" bindtap="showGradingAnalytics">
      <text class="icon">ğŸ“Š</text>
      <text>æ•°æ®ç»Ÿè®¡</text>
    </view>
    <view class="float-btn" bindtap="batchGrade">
      <text class="icon">âš¡</text>
      <text>æ‰¹é‡æ‰¹æ”¹</text>
    </view>
    <view class="float-btn" bindtap="exportGrades">
      <text class="icon">ğŸ“¥</text>
      <text>å¯¼å‡ºæˆç»©</text>
    </view>
  </view>
</view>

<!-- æ‰¹æ”¹å†å²ç»„ä»¶ -->
<grading-history 
  show="{{showGradingHistory}}"
  studentName="{{currentSubmission.user.nickname || ''}}"
  taskId="{{taskId}}"
  studentId="{{currentSubmission.user.id || ''}}"
  allowExport="{{isTeacher}}"
  bind:close="onGradingHistoryClose"
/>

<!-- æ•°æ®ç»Ÿè®¡é¢æ¿ -->
<grading-analytics
  show="{{showAnalytics}}"
  taskId="{{taskId}}"
  taskTitle="{{task.title}}"
  submissions="{{submissions}}"
  bind:close="onAnalyticsClose"
  bind:showReviewStudents="onShowReviewStudents"
  bind:applySuggestion="onApplySuggestion"
  bind:exportReport="onExportReport"
/>

<!-- åº•éƒ¨å®‰å…¨åŒºåŸŸ -->
<view class="safe-bottom"></view>