<!-- 批改页面 -->
<view class="container">
  <!-- 顶部任务信息 -->
  <view class="task-header">
    <view class="task-title">{{task.title}}</view>
    <view class="task-stats">
      <view class="stat-item">
        <text class="stat-label">待批改</text>
        <text class="stat-value">{{pendingCount}}</text>
      </view>
      <view class="stat-item">
        <text class="stat-label">已批改</text>
        <text class="stat-value">{{reviewedCount}}</text>
      </view>
    </view>
  </view>

  <!-- 批改列表或批改详情 -->
  <view wx:if="{{!currentSubmission}}" class="submission-list">
    
    <!-- 骨架屏加载状态 -->
    <skeleton show="{{loading}}" type="student-list" count="{{5}}"></skeleton>
    
    <!-- 实际内容 -->
    <view wx:if="{{!loading}}">
    <!-- 筛选栏 -->
    <view class="filter-bar">
      <view class="filter-tabs">
        <view 
          class="filter-tab {{filterStatus === 'all' ? 'active' : ''}}"
          bindtap="onFilterChange"
          data-status="all"
        >
          全部
        </view>
        <view 
          class="filter-tab {{filterStatus === 'pending' ? 'active' : ''}}"
          bindtap="onFilterChange"
          data-status="pending"
        >
          待批改
        </view>
        <view 
          class="filter-tab {{filterStatus === 'reviewed' ? 'active' : ''}}"
          bindtap="onFilterChange"
          data-status="reviewed"
        >
          已批改
        </view>
      </view>
    </view>

    <!-- 提交列表 -->
    <view class="submissions">
      <view 
        wx:for="{{submissions}}" 
        wx:key="id"
        class="submission-item"
        bindtap="selectSubmission"
        data-index="{{index}}"
      >
        <view class="student-info">
          <image class="student-avatar" src="{{item.student_info.avatar_url}}" mode="aspectFill" wx:if="{{item.student_info.avatar_url}}" lazy-load="true" binderror="onImageError"/>
          <view class="student-avatar avatar-placeholder" wx:else>
            <text>👤</text>
          </view>
          <view class="student-detail">
            <text class="student-name">{{item.student_info.nickname || '学生'}}</text>
            <text class="submit-time">{{item.submitted_at}}</text>
          </view>
        </view>
        
        <view class="submission-status">
          <view wx:if="{{item.status === 'pending'}}" class="status-badge pending">待批改</view>
          <view wx:elif="{{item.grade}}" class="grade-badge {{item.grade}}">
            {{item.gradeText}}
          </view>
        </view>
      </view>
    </view>

    <!-- 空状态 -->
    <view wx:if="{{submissions.length === 0}}" class="empty-state">
      <text class="empty-icon">📦</text>
      <text>暂无提交的作业</text>
    </view>
    
    </view> <!-- 结束实际内容 -->
  </view>

  <!-- 批改详情视图 -->
  <view wx:else class="grading-detail">
    <!-- 批改详情加载状态 -->
    <skeleton show="{{loadingSubmission}}" type="grading-detail" />
    
    <!-- 批改内容 -->
    <view wx:if="{{!loadingSubmission}}">
    <!-- 学生信息栏 -->
    <view class="student-bar">
      <view class="student-info">
        <image class="student-avatar" src="{{currentSubmission.student_info.avatar_url}}" mode="aspectFill" wx:if="{{currentSubmission.student_info.avatar_url}}" lazy-load="true" binderror="onImageError"/>
        <view class="student-avatar avatar-placeholder" wx:else>
          <text>👤</text>
        </view>
        <view class="student-detail">
          <text class="student-name">{{currentSubmission.student_info.nickname || '学生'}}</text>
          <text class="submit-info">上传时间：{{currentSubmission.submitted_at}} | 第{{currentSubmission.attemptNumber}}次上传</text>
        </view>
      </view>
    </view>

    <!-- 作业内容 -->
    <view class="submission-content">
      <view class="section-title">
        <text class="icon">📝</text>
        <text>学生提交内容</text>
      </view>
      
      
      <!-- 内容区域分块展示 -->
      <view class="submission-content-sections">
        
        <!-- 文字内容区域 -->
        <view wx:if="{{currentSubmission.text && currentSubmission.text.trim()}}" class="content-section text-section">
          <view class="content-header">
            <text class="content-icon">💬</text>
            <text class="content-title">文字说明</text>
            <text class="content-count">({{currentSubmission.text.length}}字)</text>
          </view>
          <view class="content-text">
            <text user-select="true">{{currentSubmission.text}}</text>
          </view>
        </view>
        
        <!-- 图片内容区域 -->
        <view wx:if="{{currentSubmission.images && currentSubmission.images.length > 0}}" class="content-section image-section">
          <view class="content-images">
            <scroll-view scroll-x class="image-scroll" show-scrollbar="false">
              <view class="image-list">
                <view wx:for="{{currentSubmission.images}}" wx:key="index" class="image-item">
                  <image 
                    src="{{item}}" 
                    mode="aspectFill"
                    class="content-image"
                    bindtap="previewImage"
                    data-url="{{item}}"
                    lazy-load="true"
                    show-menu-by-longpress="false"
                    binderror="onImageError"
                  />
                  <view class="image-index">{{index + 1}}</view>
                </view>
              </view>
            </scroll-view>
          </view>
          
          <!-- 图片操作提示 -->
          <view class="image-hint">
            <text>点击图片可放大查看</text>
          </view>
        </view>
        
        <!-- 文档内容区域 -->
        <view wx:if="{{currentSubmission.documents && currentSubmission.documents.length > 0}}" class="content-section document-section">
          <view class="content-header">
            <text class="content-icon">📄</text>
            <text class="content-title">提交文档</text>
            <text class="content-count">({{currentSubmission.documents.length}}个)</text>
          </view>
          <view class="content-documents">
            <view wx:for="{{currentSubmission.documents}}" wx:key="index" class="document-item">
              <view class="document-icon">
                <text wx:if="{{item.type === 'pdf'}}">📖</text>
                <text wx:elif="{{item.type === 'word'}}">📝</text>
                <text wx:else>📄</text>
              </view>
              <view class="document-info">
                <text class="document-name">{{item.name}}</text>
                <text class="document-type">{{item.type === 'pdf' ? 'PDF文档' : item.type === 'word' ? 'Word文档' : '文档文件'}}</text>
              </view>
              <view class="document-actions">
                <button class="action-btn download-btn" bindtap="downloadDocument" data-url="{{item.url}}" data-name="{{item.name}}">
                  下载
                </button>
              </view>
            </view>
          </view>
          
          <!-- 文档操作提示 -->
          <view class="document-hint">
            <text>点击下载按钮可保存文档到本地</text>
          </view>
        </view>
        
      </view>

      <!-- 空状态提示 -->
      <view wx:if="{{(!currentSubmission.images || currentSubmission.images.length === 0) && (!currentSubmission.documents || currentSubmission.documents.length === 0) && (!currentSubmission.text || !currentSubmission.text.trim())}}" class="content-section empty-section">
        <view class="empty-content">
          <text class="empty-icon">📄</text>
          <text class="empty-text">学生未提交任何内容</text>
          <text class="empty-hint">请联系学生重新提交作业</text>
        </view>
      </view>
    </view>

    <!-- 批改区域 -->
    <view class="grading-section">
      <view class="section-title">
        <text class="icon">✍️</text>
        <text>批改评价</text>
      </view>

      <!-- 评分档位 -->
      <view class="grade-options">
        <view 
          class="grade-option {{gradeData.grade === 'excellent' ? 'selected' : ''}}"
          bindtap="selectGrade"
          data-grade="excellent"
        >
          <view class="grade-icon excellent">🌟</view>
          <text class="grade-name">极佳</text>
          <text class="grade-desc">完成质量优异</text>
        </view>
        
        <view 
          class="grade-option {{gradeData.grade === 'good' ? 'selected' : ''}}"
          bindtap="selectGrade"
          data-grade="good"
        >
          <view class="grade-icon good">👍</view>
          <text class="grade-name">优秀</text>
          <text class="grade-desc">完成质量良好</text>
        </view>
        
        <view 
          class="grade-option {{gradeData.grade === 'review' ? 'selected' : ''}}"
          bindtap="selectGrade"
          data-grade="review"
        >
          <view class="grade-icon review">📚</view>
          <text class="grade-name">待复盘</text>
          <text class="grade-desc">需要改进</text>
        </view>
      </view>

  
      <!-- 简化的评语输入区域 -->
      <view class="feedback-input-section">
        <view class="input-label">批改评语</view>
        <textarea 
          class="feedback-textarea"
          placeholder="请输入批改评语，给学生一些建议和鼓励..."
          maxlength="500"
          value="{{gradeData.feedback}}"
          bindinput="onFeedbackInput"
        />
      </view>


    </view>

    <!-- 底部导航和操作按钮 -->
    <view class="bottom-actions">
      <button 
        class="nav-btn-bottom {{currentIndex === 0 ? 'disabled' : ''}}"
        bindtap="previousSubmission"
        catchtap="previousSubmission"
        data-debug="previous"
      >
        上一篇
      </button>
      <button 
        class="submit-btn-bottom {{canSubmitGrade ? 'active' : ''}}"
        disabled="{{!canSubmitGrade || isSubmitting}}"
        bindtap="submitGrade"
      >
        {{isSubmitting ? '提交中...' : '提交批改'}}
      </button>
      <button 
        class="nav-btn-bottom {{currentIndex === submissions.length - 1 ? 'disabled' : ''}}"
        bindtap="nextSubmission"
        catchtap="nextSubmission"
        data-debug="next"
      >
        下一篇
      </button>
    </view>
    </view> <!-- 结束批改内容 -->
  </view>

</view>


<!-- 底部安全区域 -->
<view class="safe-bottom"></view>