<!-- 任务详情页 -->
<view class="container">
  <!-- 加载状态 -->
  <skeleton show="{{loading}}" type="task-detail" />
  
  <!-- 顶部任务信息卡片 -->
  <view class="task-info-card" wx:if="{{!loading}}">
    <view class="task-header">
      <view class="task-title">{{task.title}}</view>
      <view class="task-meta">
        <text class="task-type {{task.type}}">{{taskTypeText}}</text>
        <text class="task-date">{{task.created_at}}</text>
      </view>
    </view>
    
    <!-- 任务要求 -->
    <view class="task-requirements">
      <view class="section-title">
        <text class="icon">📝</text>
        <text>任务要求</text>
      </view>
      <view class="requirements-content">{{task.requirements || '请按要求完成作业并提交'}}</view>
    </view>

    <!-- 截止时间 -->
    <view class="deadline-info">
      <view class="deadline-label">截止时间：</view>
      <view class="deadline-time {{isOverdue ? 'overdue' : ''}}">
        {{task.deadline || '无截止时间'}}
        <text wx:if="{{remainingTime}}" class="remaining-time">（{{remainingTime}}）</text>
      </view>
    </view>

    <!-- 提交限制提示 -->
    <view class="submit-limit-tip" wx:if="{{!isTeacher}}">
      <text class="icon">💡</text>
      <text>每个任务最多可提交3次，当前已提交 {{submissionCount}}/3 次</text>
    </view>

    <!-- 待复盘重置提示 -->
    <view class="review-reset-tip" wx:if="{{hasReviewReset && !isTeacher}}">
      <text class="icon">🔄</text>
      <text>因上次作业被评为"待复盘"，您已重新获得3次提交机会</text>
    </view>
  </view>

  <!-- 根据不同状态显示不同内容 -->
  
  <!-- 视图1：待提交状态 -->
  <view wx:if="{{viewType === 'toSubmit'}}" class="submit-section">
    <view class="section-card">
      <view class="section-title">
        <text class="icon">📤</text>
        <text>提交作业</text>
      </view>
      
      <!-- 图片上传区域 -->
      <view class="upload-area">
        <view class="upload-grid">
          <!-- 已上传的图片 -->
          <view wx:for="{{uploadedImages}}" wx:key="index" class="upload-item">
            <image 
              src="{{item}}" 
              mode="aspectFill" 
              bindtap="previewImage" 
              data-url="{{item}}"
              lazy-load="true"
              show-menu-by-longpress="false"
              binderror="onImageError"
            />
            <view class="delete-btn" bindtap="deleteImage" data-index="{{index}}">
              <text>×</text>
            </view>
          </view>
          
          <!-- 上传按钮 -->
          <view wx:if="{{uploadedImages.length < maxImages}}" class="upload-btn" bindtap="chooseImage">
            <text class="upload-icon">+</text>
            <text class="upload-text">上传图片</text>
            <text class="upload-tip">{{uploadedImages.length}}/{{maxImages}}</text>
          </view>
        </view>
        
        <view class="upload-tips">
          <text>• 最多上传9张图片</text>
          <text>• 支持jpg、png格式</text>
          <text>• 单张图片不超过10MB</text>
        </view>
      </view>

      <!-- 文字说明 -->
      <view class="text-input-area">
        <textarea 
          class="text-input"
          placeholder="可添加文字说明（选填）"
          maxlength="500"
          bindinput="onTextInput"
          value="{{submissionText}}"
        />
        <view class="text-counter">{{submissionText.length}}/500</view>
      </view>

      <!-- 提交按钮 -->
      <button 
        class="submit-btn {{canSubmit ? '' : 'disabled'}}" 
        disabled="{{!canSubmit || isSubmitting}}"
        bindtap="submitHomework"
      >
        {{isSubmitting ? '提交中...' : '提交作业'}}
      </button>
    </view>

    <!-- 历史提交记录 -->
    <view wx:if="{{historySubmissions.length > 0}}" class="history-section">
      <view class="section-title">
        <text class="icon">📋</text>
        <text>历史提交</text>
      </view>
      <view class="history-list">
        <view wx:for="{{historySubmissions}}" wx:key="id" class="history-item">
          <view class="history-header">
            <text class="submission-time">第{{item.attemptNumber}}次提交：{{item.submitted_at}}</text>
            <text class="submission-status {{item.status}}">{{item.statusText}}</text>
          </view>
          <view wx:if="{{item.grade}}" class="history-grade">
            <text class="grade-label">评价：</text>
            <text class="grade-value {{item.grade}}">{{item.gradeText}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 视图2：待批改状态 -->
  <view wx:elif="{{viewType === 'pending'}}" class="pending-section">
    <view class="section-card">
      <view class="status-banner pending">
        <text class="status-icon">⏳</text>
        <view class="status-info">
          <text class="status-title">作业已提交</text>
          <text class="status-desc">等待老师批改，预计24小时内完成</text>
        </view>
      </view>

      <!-- 已提交内容预览 -->
      <view class="submission-preview">
        <view class="section-title">
          <text class="icon">📄</text>
          <text>提交内容</text>
        </view>
        
        <!-- 提交时间 -->
        <view class="submit-time">
          提交时间：{{currentSubmission.submitted_at}}
        </view>

        <!-- 图片预览 -->
        <view wx:if="{{currentSubmission.images && currentSubmission.images.length > 0}}" class="preview-images">
          <scroll-view scroll-x class="image-scroll">
            <view class="image-list">
              <image 
                wx:for="{{currentSubmission.images}}" 
                wx:key="index"
                src="{{item}}" 
                mode="aspectFill"
                class="preview-image"
                bindtap="previewSubmittedImage"
                data-url="{{item}}"
                lazy-load="true"
                show-menu-by-longpress="false"
                binderror="onImageError"
              />
            </view>
          </scroll-view>
        </view>

        <!-- 文字内容 -->
        <view wx:if="{{currentSubmission.text}}" class="preview-text">
          <text>{{currentSubmission.text}}</text>
        </view>
      </view>

      <!-- 操作按钮 -->
      <view class="action-buttons">
        <button wx:if="{{submissionCount < 3}}" class="resubmit-btn" bindtap="resubmit">
          重新提交（{{submissionCount}}/3）
        </button>
      </view>
    </view>
  </view>

  <!-- 视图3：已批改状态 -->
  <view wx:elif="{{viewType === 'reviewed'}}" class="reviewed-section">
    <view class="section-card">
      <!-- 评价结果 -->
      <view class="grade-result-card {{currentSubmission.grade}}">
        <view class="grade-header">
          <text class="grade-icon">{{currentSubmission.grade === 'excellent' ? '🎆' : currentSubmission.grade === 'good' ? '👍' : '📖'}}</text>
          <view class="grade-info">
            <text class="grade-title">{{gradeTitle}}</text>
            <text class="grade-desc">{{gradeDesc}}</text>
          </view>
        </view>
        
        <!-- 得分详情 -->
        <view wx:if="{{currentSubmission.score}}" class="score-detail">
          <text class="score-label">得分：</text>
          <text class="score-value">{{currentSubmission.score}}</text>
          <text class="score-total">/{{task.total_score || 100}}</text>
        </view>
      </view>

      <!-- 老师评语 -->
      <view class="teacher-feedback">
        <view class="section-title">
          <text class="icon">💬</text>
          <text>老师评语</text>
        </view>
        <view class="feedback-content">
          {{currentSubmission.feedback || '暂无评语'}}
        </view>
        <view wx:if="{{currentSubmission.graded_by}}" class="feedback-footer">
          <text>批改老师：{{currentSubmission.graded_by}}</text>
          <text>批改时间：{{currentSubmission.graded_at}}</text>
        </view>
      </view>

      <!-- 作业内容 -->
      <view class="submission-content">
        <view class="section-title">
          <text class="icon">📝</text>
          <text>我的作业</text>
        </view>
        
        <!-- 图片展示 -->
        <view wx:if="{{currentSubmission.images && currentSubmission.images.length > 0}}" class="content-images">
          <view class="image-grid">
            <image 
              wx:for="{{currentSubmission.images}}" 
              wx:key="index"
              src="{{item}}" 
              mode="aspectFill"
              class="content-image"
              bindtap="previewSubmittedImage"
              data-url="{{item}}"
              lazy-load="true"
              show-menu-by-longpress="false"
              binderror="onImageError"
            />
          </view>
        </view>

        <!-- 文字内容 -->
        <view wx:if="{{currentSubmission.text}}" class="content-text">
          <text>{{currentSubmission.text}}</text>
        </view>
      </view>

      <!-- 操作按钮 -->
      <view class="action-buttons">
        <button wx:if="{{submissionCount < 3 && !task.is_ended}}" class="resubmit-btn outline" bindtap="resubmit">
          重新提交（{{submissionCount}}/3）
        </button>
        <button class="history-btn outline" bindtap="showMyGradingHistory">
          查看批改历史
        </button>
        <button class="share-btn" open-type="share">
          分享成绩
        </button>
      </view>
    </view>
  </view>

  <!-- 教师视图：批改入口 -->
  <view wx:if="{{isTeacher}}" class="teacher-section">
    <view class="section-card">
      <view class="section-title">
        <text class="icon">👨‍🏫</text>
        <text>教师操作</text>
      </view>
      
      <view class="teacher-stats">
        <view class="stat-item">
          <text class="stat-label">已提交</text>
          <text class="stat-value">{{stats.submitted || 0}}</text>
        </view>
        <view class="stat-item">
          <text class="stat-label">待批改</text>
          <text class="stat-value">{{stats.pending || 0}}</text>
        </view>
        <view class="stat-item">
          <text class="stat-label">已批改</text>
          <text class="stat-value">{{stats.reviewed || 0}}</text>
        </view>
      </view>

      <view class="teacher-actions">
        <button class="action-btn primary" bindtap="goToGrading">
          开始批改
        </button>
        <button class="action-btn" bindtap="exportSubmissions">
          导出作业
        </button>
        <button class="action-btn" bindtap="viewStatistics">
          查看统计
        </button>
      </view>
    </view>
  </view>
</view>

<!-- 上传进度组件 -->
<upload-progress 
  show="{{showUploadProgress}}" 
  showSimple="{{showSimpleProgress}}"
  bind:close="onUploadProgressClose"
  bind:progressUpdate="onUploadProgressUpdate"
  bind:uploadSuccess="onUploadSuccess"
  bind:uploadError="onUploadError"
  bind:uploadCanceled="onUploadCanceled"
/>

<!-- 学生批改历史组件 -->
<grading-history 
  show="{{showMyGradingHistory}}"
  studentName="{{userInfo.nickname}}"
  taskId="{{taskId}}"
  studentId="{{userInfo.id}}"
  allowExport="{{false}}"
  bind:close="onMyGradingHistoryClose"
/>

<!-- 底部安全区域 -->
<view class="safe-bottom"></view>