<!-- ä»»åŠ¡è¯¦æƒ…é¡µ -->
<view class="container">
  <!-- åŠ è½½çŠ¶æ€ -->
  <skeleton show="{{loading}}" type="task-detail" />
  
  <!-- é¡¶éƒ¨ä»»åŠ¡ä¿¡æ¯å¡ç‰‡ -->
  <view class="task-info-card" wx:if="{{!loading}}">
    <view class="task-header">
      <view class="task-title">{{task.title}}</view>
      <view class="task-meta">
        <text class="task-type {{task.type}}">{{taskTypeText}}</text>
        <text class="task-date">{{formattedLiveTime}}</text>
      </view>
    </view>
    
    <!-- ä»»åŠ¡è¦æ±‚ -->
    <view class="task-requirements">
      <view class="section-title">
        <text class="icon">ğŸ“</text>
        <text>ä»»åŠ¡è¦æ±‚</text>
      </view>
      <view class="requirements-content">{{task.desc || 'è¯·æŒ‰è¦æ±‚å®Œæˆä½œä¸šå¹¶æäº¤'}}</view>
    </view>

    <!-- æˆªæ­¢æ—¶é—´ -->
    <view class="deadline-info">
      <view class="deadline-label">æˆªæ­¢æ—¶é—´ï¼š</view>
      <view class="deadline-time {{isOverdue ? 'overdue' : ''}}">
        {{formattedDeadline}}
        <text wx:if="{{remainingTime}}" class="remaining-time">ï¼ˆ{{remainingTime}}ï¼‰</text>
      </view>
    </view>

    <!-- æäº¤é™åˆ¶æç¤º -->
    <view class="submit-limit-tip" wx:if="{{!isTeacher}}">
      <text class="icon">ğŸ’¡</text>
      <text>å½“å‰å·²æäº¤ {{submissionCount}}/3 æ¬¡</text>
    </view>

    <!-- å¾…å¤ç›˜é‡ç½®æç¤º -->
    <view class="review-reset-tip" wx:if="{{hasReviewReset && !isTeacher}}">
      <text class="icon">ğŸ”„</text>
      <text>å› ä¸Šæ¬¡ä½œä¸šè¢«è¯„ä¸º"å¾…å¤ç›˜"ï¼Œæ‚¨å·²é‡æ–°è·å¾—3æ¬¡æäº¤æœºä¼š</text>
    </view>
  </view>

  <!-- æ ¹æ®ä¸åŒçŠ¶æ€æ˜¾ç¤ºä¸åŒå†…å®¹ -->
  
  <!-- è§†å›¾1ï¼šå¾…æäº¤çŠ¶æ€ -->
  <view wx:if="{{viewType === 'toSubmit'}}" class="submit-section">
    <view class="section-card">
      <view class="section-title">
        <text class="icon">ğŸ“¤</text>
        <text>ä½œä¸šæäº¤</text>
      </view>
      
      <!-- ç®€åŒ–çš„ä¸Šä¼ åŒºåŸŸ -->
      <view class="upload-area">
        <!-- å·²ä¸Šä¼ å›¾ç‰‡é¢„è§ˆ -->
        <view wx:if="{{uploadedFiles.length > 0}}" class="uploaded-images">
          <view wx:for="{{uploadedFiles}}" wx:key="index" class="image-preview">
            <image 
              src="{{item.path}}" 
              class="preview-image" 
              mode="aspectFill"
              bindtap="previewFile" 
              data-index="{{index}}"
            />
            <view class="image-delete-btn" bindtap="deleteFile" data-index="{{index}}">Ã—</view>
          </view>
        </view>
        
        <!-- ç©ºçŠ¶æ€ä¸Šä¼ æç¤º -->
        <view wx:else class="upload-placeholder">
          <view class="upload-icon">
            <text class="icon">ğŸ“·</text>
          </view>
          <text class="upload-hint">è¯·ä¸Šä¼ æ‚¨çš„ä½œä¸šå›¾ç‰‡</text>
        </view>
        
        <!-- ä¸Šä¼ æŒ‰é’® -->
        <button 
          class="upload-btn-primary {{isOverdue ? 'disabled' : ''}}" 
          disabled="{{isOverdue}}"
          bindtap="chooseImages"
        >
          {{isOverdue ? 'ä½œä¸šå·²æˆªæ­¢' : 'ä¸Šä¼ å›¾ç‰‡æäº¤ä½œä¸š'}}
        </button>
      </view>

      <!-- æäº¤æŒ‰é’® -->
      <button 
        wx:if="{{uploadedFiles.length > 0}}"
        class="submit-btn {{canSubmit && !isOverdue ? 'primary' : 'disabled'}}" 
        disabled="{{!canSubmit || isSubmitting || isOverdue}}"
        bindtap="submitHomework"
      >
        {{isOverdue ? 'ä½œä¸šå·²æˆªæ­¢' : (isSubmitting ? 'æäº¤ä¸­...' : 'æäº¤ä½œä¸š')}}
      </button>
    </view>

    <!-- å†å²æäº¤è®°å½• -->
    <view wx:if="{{historySubmissions.length > 0}}" class="history-section">
      <view class="section-title">
        <text class="icon">ğŸ“‹</text>
        <text>å†å²æäº¤</text>
      </view>
      <view class="history-list">
        <view wx:for="{{historySubmissions}}" wx:key="id" class="history-item">
          <view class="history-header">
            <text class="submission-time">ç¬¬{{item.attemptNumber}}æ¬¡æäº¤ï¼š{{item.submitted_at}}</text>
            <text class="submission-status {{item.status}}">{{item.statusText}}</text>
          </view>
          <view wx:if="{{item.grade}}" class="history-grade">
            <text class="grade-label">è¯„ä»·ï¼š</text>
            <text class="grade-value {{item.grade}}">{{item.gradeText}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- è§†å›¾2ï¼šå¾…æ‰¹æ”¹çŠ¶æ€ -->
  <view wx:elif="{{viewType === 'pending'}}" class="pending-section">
    <view class="section-card">
      <view class="status-banner pending">
        <text class="status-icon">â³</text>
        <view class="status-info">
          <text class="status-title">ä½œä¸šå·²æäº¤</text>
          <text class="status-desc">ç­‰å¾…è€å¸ˆæ‰¹æ”¹ï¼Œé¢„è®¡24å°æ—¶å†…å®Œæˆ</text>
        </view>
      </view>

      <!-- å·²æäº¤å†…å®¹é¢„è§ˆ -->
      <view class="submission-preview">
        <view class="section-title">
          <text class="icon">ğŸ“„</text>
          <text>æäº¤å†…å®¹</text>
        </view>
        
        <!-- æäº¤æ—¶é—´ -->
        <view class="submit-time">
          æäº¤æ—¶é—´ï¼š{{currentSubmission.submitted_at}}
        </view>

        <!-- å›¾ç‰‡é¢„è§ˆ -->
        <view wx:if="{{currentSubmission.images && currentSubmission.images.length > 0}}" class="preview-images">
          <scroll-view scroll-x class="image-scroll">
            <view class="image-list">
              <image 
                wx:for="{{currentSubmission.images}}" 
                wx:key="index"
                src="{{item}}" 
                mode="aspectFill"
                class="preview-image"
                bindtap="previewSubmittedImage"
                data-url="{{item}}"
                lazy-load="true"
                show-menu-by-longpress="false"
                binderror="onImageError"
              />
            </view>
          </scroll-view>
        </view>

        <!-- æ–‡å­—å†…å®¹ -->
        <view wx:if="{{currentSubmission.text}}" class="preview-text">
          <text>{{currentSubmission.text}}</text>
        </view>
      </view>

      <!-- æ“ä½œæŒ‰é’® -->
      <view class="action-buttons">
        <button wx:if="{{submissionCount < 3 && canResubmit}}" class="resubmit-btn {{canResubmit ? '' : 'disabled'}}" disabled="{{!canResubmit}}" bindtap="resubmit">
          é‡æ–°æäº¤
        </button>
      </view>
    </view>
  </view>

  <!-- è§†å›¾3ï¼šå·²æ‰¹æ”¹çŠ¶æ€ -->
  <view wx:elif="{{viewType === 'reviewed'}}" class="reviewed-section">
    <!-- æ‰¹æ”¹ç»“æœæ ‡é¢˜ -->
    <view class="section-title">
      <text class="icon">âœ¨</text>
      <text>æ‰¹æ”¹ç»“æœ</text>
    </view>

    <!-- æˆ‘çš„ä½œä¸š -->
    <view class="my-work-card">
      <view class="work-title">
        <text class="icon">ğŸ“</text>
        <text>æˆ‘çš„ä½œä¸š</text>
      </view>
      
      <!-- å›¾ç‰‡å±•ç¤º (å°å›¾ç‰‡) -->
      <view wx:if="{{currentSubmission.images && currentSubmission.images.length > 0}}" class="work-images">
        <image 
          wx:for="{{currentSubmission.images}}" 
          wx:key="index"
          src="{{item}}" 
          mode="aspectFill"
          class="work-image-small"
          bindtap="previewSubmittedImage"
          data-url="{{item}}"
          lazy-load="true"
          show-menu-by-longpress="false"
          binderror="onImageError"
        />
      </view>

      <!-- æ–‡å­—å†…å®¹ -->
      <view wx:if="{{currentSubmission.text}}" class="work-text">
        <text>{{currentSubmission.text}}</text>
      </view>
    </view>

    <!-- è¯„åˆ†çŠ¶æ€å¡ç‰‡ -->
    <view class="grade-status-card {{currentSubmission.grade}}">
      <view class="grade-badge">
        <text class="grade-icon">{{currentSubmission.grade === 'excellent' ? 'ğŸ’«' : currentSubmission.grade === 'good' ? 'â­' : 'ğŸ”„'}}</text>
        <text class="grade-text">{{gradeTitle}}</text>
      </view>
      <text class="grade-description">{{gradeDesc}}</text>
    </view>

    <!-- è€å¸ˆè¯„è¯­ -->
    <view wx:if="{{currentSubmission.comment}}" class="teacher-comment">
      <view class="comment-title">
        <text class="icon">ğŸ’¬</text>
        <text>è€å¸ˆè¯„è¯­</text>
      </view>
      <view class="comment-content">
        {{currentSubmission.comment}}
      </view>
    </view>

    <!-- æ“ä½œæŒ‰é’® -->
    <view class="action-buttons">
      <!-- å¤ç›˜å®ŒæˆæŒ‰é’® -->
      <button wx:if="{{fromReview}}" class="complete-review-btn primary" bindtap="completeReview">
        å®Œæˆå¤ç›˜
      </button>
      
      <!-- é‡æ–°æäº¤æŒ‰é’® -->
      <button wx:if="{{!fromReview && submissionCount < 3 && !task.is_ended && canResubmit}}" class="resubmit-btn outline {{canResubmit ? '' : 'disabled'}}" disabled="{{!canResubmit}}" bindtap="resubmit">
        é‡æ–°æäº¤
      </button>
    </view>
  </view>

</view>

<!-- ä¸Šä¼ è¿›åº¦ç»„ä»¶ -->
<upload-progress 
  show="{{showUploadProgress}}" 
  showSimple="{{showSimpleProgress}}"
  bind:close="onUploadProgressClose"
  bind:progressUpdate="onUploadProgressUpdate"
  bind:uploadSuccess="onUploadSuccess"
  bind:uploadError="onUploadError"
  bind:uploadCanceled="onUploadCanceled"
/>

<!-- å­¦ç”Ÿæ‰¹æ”¹å†å²ç»„ä»¶ -->
<grading-history 
  show="{{showMyGradingHistory}}"
  studentName="{{userInfo.nickname}}"
  taskId="{{taskId}}"
  studentId="{{userInfo.id}}"
  allowExport="{{false}}"
  bind:close="onMyGradingHistoryClose"
/>

<!-- å‡çº§å¼•å¯¼ç»„ä»¶ -->
<upgrade-guide 
  show="{{showUpgradeGuide}}"
  guideType="{{upgradeGuideType}}"
  featureName="ä»»åŠ¡è¯¦æƒ…"
  bind:close="onUpgradeGuideClose"
/>

<!-- è¯•ç”¨é™åˆ¶æç¤ºç»„ä»¶ -->
<trial-restriction 
  show="{{showTrialRestriction}}"
  bind:close="onTrialRestrictionClose"
/>

<!-- åº•éƒ¨å®‰å…¨åŒºåŸŸ -->
<view class="safe-bottom"></view>