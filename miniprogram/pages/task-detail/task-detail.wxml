<!-- ä»»åŠ¡è¯¦æƒ…é¡µ -->
<view class="container">
  <!-- åŠ è½½çŠ¶æ€ -->
  <skeleton show="{{loading}}" type="task-detail" />
  
  <!-- é¡¶éƒ¨ä»»åŠ¡ä¿¡æ¯å¡ç‰‡ -->
  <view class="task-info-card" wx:if="{{!loading}}">
    <view class="task-header">
      <view class="task-title">{{task.title}}</view>
      <view class="task-meta">
        <text class="task-type {{task.type}}">{{taskTypeText}}</text>
        <text class="task-date">{{task.created_at}}</text>
      </view>
    </view>
    
    <!-- ä»»åŠ¡è¦æ±‚ -->
    <view class="task-requirements">
      <view class="section-title">
        <text class="icon">ğŸ“</text>
        <text>ä»»åŠ¡è¦æ±‚</text>
      </view>
      <view class="requirements-content">{{task.requirements || 'è¯·æŒ‰è¦æ±‚å®Œæˆä½œä¸šå¹¶æäº¤'}}</view>
    </view>

    <!-- æˆªæ­¢æ—¶é—´ -->
    <view class="deadline-info">
      <view class="deadline-label">æˆªæ­¢æ—¶é—´ï¼š</view>
      <view class="deadline-time {{isOverdue ? 'overdue' : ''}}">
        {{task.deadline || 'æ— æˆªæ­¢æ—¶é—´'}}
        <text wx:if="{{remainingTime}}" class="remaining-time">ï¼ˆ{{remainingTime}}ï¼‰</text>
      </view>
    </view>

    <!-- æäº¤é™åˆ¶æç¤º -->
    <view class="submit-limit-tip" wx:if="{{!isTeacher}}">
      <text class="icon">ğŸ’¡</text>
      <text>æ¯ä¸ªä»»åŠ¡æœ€å¤šå¯æäº¤3æ¬¡ï¼Œå½“å‰å·²æäº¤ {{submissionCount}}/3 æ¬¡</text>
    </view>

    <!-- å¾…å¤ç›˜é‡ç½®æç¤º -->
    <view class="review-reset-tip" wx:if="{{hasReviewReset && !isTeacher}}">
      <text class="icon">ğŸ”„</text>
      <text>å› ä¸Šæ¬¡ä½œä¸šè¢«è¯„ä¸º"å¾…å¤ç›˜"ï¼Œæ‚¨å·²é‡æ–°è·å¾—3æ¬¡æäº¤æœºä¼š</text>
    </view>
  </view>

  <!-- æ ¹æ®ä¸åŒçŠ¶æ€æ˜¾ç¤ºä¸åŒå†…å®¹ -->
  
  <!-- è§†å›¾1ï¼šå¾…æäº¤çŠ¶æ€ -->
  <view wx:if="{{viewType === 'toSubmit'}}" class="submit-section">
    <view class="section-card">
      <view class="section-title">
        <text class="icon">ğŸ“¤</text>
        <text>æäº¤ä½œä¸š</text>
      </view>
      
      <!-- å›¾ç‰‡ä¸Šä¼ åŒºåŸŸ -->
      <view class="upload-area">
        <view class="upload-grid">
          <!-- å·²ä¸Šä¼ çš„å›¾ç‰‡ -->
          <view wx:for="{{uploadedImages}}" wx:key="index" class="upload-item">
            <image 
              src="{{item}}" 
              mode="aspectFill" 
              bindtap="previewImage" 
              data-url="{{item}}"
              lazy-load="true"
              show-menu-by-longpress="false"
              binderror="onImageError"
            />
            <view class="delete-btn" bindtap="deleteImage" data-index="{{index}}">
              <text>Ã—</text>
            </view>
          </view>
          
          <!-- ä¸Šä¼ æŒ‰é’® -->
          <view wx:if="{{uploadedImages.length < maxImages}}" class="upload-btn" bindtap="chooseImage">
            <text class="upload-icon">+</text>
            <text class="upload-text">ä¸Šä¼ å›¾ç‰‡</text>
            <text class="upload-tip">{{uploadedImages.length}}/{{maxImages}}</text>
          </view>
        </view>
        
        <view class="upload-tips">
          <text>â€¢ æœ€å¤šä¸Šä¼ 9å¼ å›¾ç‰‡</text>
          <text>â€¢ æ”¯æŒjpgã€pngæ ¼å¼</text>
          <text>â€¢ å•å¼ å›¾ç‰‡ä¸è¶…è¿‡10MB</text>
        </view>
      </view>

      <!-- æ–‡å­—è¯´æ˜ -->
      <view class="text-input-area">
        <textarea 
          class="text-input"
          placeholder="å¯æ·»åŠ æ–‡å­—è¯´æ˜ï¼ˆé€‰å¡«ï¼‰"
          maxlength="500"
          bindinput="onTextInput"
          value="{{submissionText}}"
        />
        <view class="text-counter">{{submissionText.length}}/500</view>
      </view>

      <!-- æäº¤æŒ‰é’® -->
      <button 
        class="submit-btn {{canSubmit ? '' : 'disabled'}}" 
        disabled="{{!canSubmit || isSubmitting}}"
        bindtap="submitHomework"
      >
        {{isSubmitting ? 'æäº¤ä¸­...' : 'æäº¤ä½œä¸š'}}
      </button>
    </view>

    <!-- å†å²æäº¤è®°å½• -->
    <view wx:if="{{historySubmissions.length > 0}}" class="history-section">
      <view class="section-title">
        <text class="icon">ğŸ“‹</text>
        <text>å†å²æäº¤</text>
      </view>
      <view class="history-list">
        <view wx:for="{{historySubmissions}}" wx:key="id" class="history-item">
          <view class="history-header">
            <text class="submission-time">ç¬¬{{item.attemptNumber}}æ¬¡æäº¤ï¼š{{item.submitted_at}}</text>
            <text class="submission-status {{item.status}}">{{item.statusText}}</text>
          </view>
          <view wx:if="{{item.grade}}" class="history-grade">
            <text class="grade-label">è¯„ä»·ï¼š</text>
            <text class="grade-value {{item.grade}}">{{item.gradeText}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- è§†å›¾2ï¼šå¾…æ‰¹æ”¹çŠ¶æ€ -->
  <view wx:elif="{{viewType === 'pending'}}" class="pending-section">
    <view class="section-card">
      <view class="status-banner pending">
        <text class="status-icon">â³</text>
        <view class="status-info">
          <text class="status-title">ä½œä¸šå·²æäº¤</text>
          <text class="status-desc">ç­‰å¾…è€å¸ˆæ‰¹æ”¹ï¼Œé¢„è®¡24å°æ—¶å†…å®Œæˆ</text>
        </view>
      </view>

      <!-- å·²æäº¤å†…å®¹é¢„è§ˆ -->
      <view class="submission-preview">
        <view class="section-title">
          <text class="icon">ğŸ“„</text>
          <text>æäº¤å†…å®¹</text>
        </view>
        
        <!-- æäº¤æ—¶é—´ -->
        <view class="submit-time">
          æäº¤æ—¶é—´ï¼š{{currentSubmission.submitted_at}}
        </view>

        <!-- å›¾ç‰‡é¢„è§ˆ -->
        <view wx:if="{{currentSubmission.images && currentSubmission.images.length > 0}}" class="preview-images">
          <scroll-view scroll-x class="image-scroll">
            <view class="image-list">
              <image 
                wx:for="{{currentSubmission.images}}" 
                wx:key="index"
                src="{{item}}" 
                mode="aspectFill"
                class="preview-image"
                bindtap="previewSubmittedImage"
                data-url="{{item}}"
                lazy-load="true"
                show-menu-by-longpress="false"
                binderror="onImageError"
              />
            </view>
          </scroll-view>
        </view>

        <!-- æ–‡å­—å†…å®¹ -->
        <view wx:if="{{currentSubmission.text}}" class="preview-text">
          <text>{{currentSubmission.text}}</text>
        </view>
      </view>

      <!-- æ“ä½œæŒ‰é’® -->
      <view class="action-buttons">
        <button wx:if="{{submissionCount < 3}}" class="resubmit-btn" bindtap="resubmit">
          é‡æ–°æäº¤ï¼ˆ{{submissionCount}}/3ï¼‰
        </button>
      </view>
    </view>
  </view>

  <!-- è§†å›¾3ï¼šå·²æ‰¹æ”¹çŠ¶æ€ -->
  <view wx:elif="{{viewType === 'reviewed'}}" class="reviewed-section">
    <view class="section-card">
      <!-- è¯„ä»·ç»“æœ -->
      <view class="grade-result-card {{currentSubmission.grade}}">
        <view class="grade-header">
          <text class="grade-icon">{{currentSubmission.grade === 'excellent' ? 'ğŸ†' : currentSubmission.grade === 'good' ? 'ğŸ‘' : 'ğŸ“–'}}</text>
          <view class="grade-info">
            <text class="grade-title">{{gradeTitle}}</text>
            <text class="grade-desc">{{gradeDesc}}</text>
          </view>
        </view>
        
        <!-- å¾—åˆ†è¯¦æƒ… -->
        <view wx:if="{{currentSubmission.score}}" class="score-detail">
          <text class="score-label">å¾—åˆ†ï¼š</text>
          <text class="score-value">{{currentSubmission.score}}</text>
          <text class="score-total">/{{task.total_score || 100}}</text>
        </view>
      </view>

      <!-- è€å¸ˆè¯„è¯­ -->
      <view class="teacher-feedback">
        <view class="section-title">
          <text class="icon">ğŸ’¬</text>
          <text>è€å¸ˆè¯„è¯­</text>
        </view>
        <view class="feedback-content">
          {{currentSubmission.feedback || 'æš‚æ— è¯„è¯­'}}
        </view>
        <view wx:if="{{currentSubmission.graded_by}}" class="feedback-footer">
          <text>æ‰¹æ”¹è€å¸ˆï¼š{{currentSubmission.graded_by}}</text>
          <text>æ‰¹æ”¹æ—¶é—´ï¼š{{currentSubmission.graded_at}}</text>
        </view>
      </view>

      <!-- ä½œä¸šå†…å®¹ -->
      <view class="submission-content">
        <view class="section-title">
          <text class="icon">ğŸ“</text>
          <text>æˆ‘çš„ä½œä¸š</text>
        </view>
        
        <!-- å›¾ç‰‡å±•ç¤º -->
        <view wx:if="{{currentSubmission.images && currentSubmission.images.length > 0}}" class="content-images">
          <view class="image-grid">
            <image 
              wx:for="{{currentSubmission.images}}" 
              wx:key="index"
              src="{{item}}" 
              mode="aspectFill"
              class="content-image"
              bindtap="previewSubmittedImage"
              data-url="{{item}}"
              lazy-load="true"
              show-menu-by-longpress="false"
              binderror="onImageError"
            />
          </view>
        </view>

        <!-- æ–‡å­—å†…å®¹ -->
        <view wx:if="{{currentSubmission.text}}" class="content-text">
          <text>{{currentSubmission.text}}</text>
        </view>
      </view>

      <!-- æ“ä½œæŒ‰é’® -->
      <view class="action-buttons">
        <button wx:if="{{submissionCount < 3 && !task.is_ended}}" class="resubmit-btn outline" bindtap="resubmit">
          é‡æ–°æäº¤ï¼ˆ{{submissionCount}}/3ï¼‰
        </button>
        <button class="history-btn outline" bindtap="showMyGradingHistory">
          æŸ¥çœ‹æ‰¹æ”¹å†å²
        </button>
        <button class="share-btn" open-type="share">
          åˆ†äº«æˆç»©
        </button>
      </view>
    </view>
  </view>

  <!-- æ•™å¸ˆè§†å›¾ï¼šæ‰¹æ”¹å…¥å£ -->
  <view wx:if="{{isTeacher}}" class="teacher-section">
    <view class="section-card">
      <view class="section-title">
        <text class="icon">ğŸ‘¨â€ğŸ«</text>
        <text>æ•™å¸ˆæ“ä½œ</text>
      </view>
      
      <view class="teacher-stats">
        <view class="stat-item">
          <text class="stat-label">å·²æäº¤</text>
          <text class="stat-value">{{stats.submitted || 0}}</text>
        </view>
        <view class="stat-item">
          <text class="stat-label">å¾…æ‰¹æ”¹</text>
          <text class="stat-value">{{stats.pending || 0}}</text>
        </view>
        <view class="stat-item">
          <text class="stat-label">å·²æ‰¹æ”¹</text>
          <text class="stat-value">{{stats.reviewed || 0}}</text>
        </view>
      </view>

      <view class="teacher-actions">
        <button class="action-btn primary" bindtap="goToGrading">
          å¼€å§‹æ‰¹æ”¹
        </button>
        <button class="action-btn" bindtap="exportSubmissions">
          å¯¼å‡ºä½œä¸š
        </button>
        <button class="action-btn" bindtap="viewStatistics">
          æŸ¥çœ‹ç»Ÿè®¡
        </button>
      </view>
    </view>
  </view>
</view>

<!-- ä¸Šä¼ è¿›åº¦ç»„ä»¶ -->
<upload-progress 
  show="{{showUploadProgress}}" 
  showSimple="{{showSimpleProgress}}"
  bind:close="onUploadProgressClose"
  bind:progressUpdate="onUploadProgressUpdate"
  bind:uploadSuccess="onUploadSuccess"
  bind:uploadError="onUploadError"
  bind:uploadCanceled="onUploadCanceled"
/>

<!-- å­¦ç”Ÿæ‰¹æ”¹å†å²ç»„ä»¶ -->
<grading-history 
  show="{{showMyGradingHistory}}"
  studentName="{{userInfo.nickname}}"
  taskId="{{taskId}}"
  studentId="{{userInfo.id}}"
  allowExport="{{false}}"
  bind:close="onMyGradingHistoryClose"
/>

<!-- åº•éƒ¨å®‰å…¨åŒºåŸŸ -->
<view class="safe-bottom"></view>