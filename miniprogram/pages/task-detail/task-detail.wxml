<!-- 任务详情页 -->
<view class="container">
  <!-- 加载状态 -->
  <skeleton show="{{loading}}" type="task-detail" />
  
  <!-- 顶部任务信息卡片 -->
  <view class="task-info-card" wx:if="{{!loading}}">
    <view class="task-header">
      <view class="task-title">{{task.title}}</view>
      <view class="task-meta">
        <text class="task-type {{task.type}}">{{taskTypeText}}</text>
        <text class="task-date">{{formattedLiveTime}}</text>
      </view>
    </view>
    
    <!-- 任务要求 -->
    <view class="task-requirements">
      <view class="section-title">
        <text class="icon">📝</text>
        <text>任务要求</text>
      </view>
      <view class="requirements-content">{{task.desc || '请按要求完成作业并提交'}}</view>
    </view>

    <!-- 截止时间 -->
    <view class="deadline-info">
      <view class="deadline-label">截止时间：</view>
      <view class="deadline-time {{isOverdue ? 'overdue' : ''}}">
        {{formattedDeadline}}
        <text wx:if="{{remainingTime}}" class="remaining-time">（{{remainingTime}}）</text>
      </view>
    </view>

    <!-- 提交限制提示 -->
    <view class="submit-limit-tip" wx:if="{{!isTeacher}}">
      <text class="icon">💡</text>
      <text>当前已提交 {{submissionCount}}/3 次</text>
    </view>

    <!-- 待复盘重置提示 -->
    <view class="review-reset-tip" wx:if="{{hasReviewReset && !isTeacher}}">
      <text class="icon">🔄</text>
      <text>因上次作业被评为"待复盘"，您已重新获得3次提交机会</text>
    </view>
  </view>

  <!-- 根据不同状态显示不同内容 -->
  
  <!-- 视图1：待提交状态 -->
  <view wx:if="{{viewType === 'toSubmit'}}" class="submit-section">
    <view class="section-card">
      <view class="section-title">
        <text class="icon">📤</text>
        <text>作业提交</text>
      </view>
      
      <!-- 简化的上传区域 -->
      <view class="upload-area">
        <!-- 已上传图片预览 -->
        <view wx:if="{{uploadedFiles.length > 0}}" class="uploaded-images">
          <view wx:for="{{uploadedFiles}}" wx:key="index" class="image-preview">
            <image 
              src="{{item.path}}" 
              class="preview-image" 
              mode="aspectFill"
              bindtap="previewFile" 
              data-index="{{index}}"
            />
            <view class="image-delete-btn" bindtap="deleteFile" data-index="{{index}}">×</view>
          </view>
        </view>
        
        <!-- 空状态上传提示 -->
        <view wx:else class="upload-placeholder">
          <view class="upload-icon">
            <text class="icon">📷</text>
          </view>
          <text class="upload-hint">请上传您的作业图片</text>
        </view>
        
        <!-- 上传按钮 -->
        <button 
          class="upload-btn-primary {{isOverdue ? 'disabled' : ''}}" 
          disabled="{{isOverdue}}"
          bindtap="chooseImages"
        >
          {{isOverdue ? '作业已截止' : '上传图片提交作业'}}
        </button>
      </view>

      <!-- 提交按钮 -->
      <button 
        wx:if="{{uploadedFiles.length > 0}}"
        class="submit-btn {{canSubmit && !isOverdue ? 'primary' : 'disabled'}}" 
        disabled="{{!canSubmit || isSubmitting || isOverdue}}"
        bindtap="submitHomework"
      >
        {{isOverdue ? '作业已截止' : (isSubmitting ? '提交中...' : '提交作业')}}
      </button>
    </view>

    <!-- 历史提交记录 -->
    <view wx:if="{{historySubmissions.length > 0}}" class="history-section">
      <view class="section-title">
        <text class="icon">📋</text>
        <text>历史提交</text>
      </view>
      <view class="history-list">
        <view wx:for="{{historySubmissions}}" wx:key="id" class="history-item">
          <view class="history-header">
            <text class="submission-time">第{{item.attemptNumber}}次提交：{{item.submitted_at}}</text>
            <text class="submission-status {{item.status}}">{{item.statusText}}</text>
          </view>
          <view wx:if="{{item.grade}}" class="history-grade">
            <text class="grade-label">评价：</text>
            <text class="grade-value {{item.grade}}">{{item.gradeText}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 视图2：待批改状态 -->
  <view wx:elif="{{viewType === 'pending'}}" class="pending-section">
    <view class="section-card">
      <view class="status-banner pending">
        <text class="status-icon">⏳</text>
        <view class="status-info">
          <text class="status-title">作业已提交</text>
          <text class="status-desc">等待老师批改，预计24小时内完成</text>
        </view>
      </view>

      <!-- 已提交内容预览 -->
      <view class="submission-preview">
        <view class="section-title">
          <text class="icon">📄</text>
          <text>提交内容</text>
        </view>
        
        <!-- 提交时间 -->
        <view class="submit-time">
          提交时间：{{currentSubmission.submitted_at}}
        </view>

        <!-- 图片预览 -->
        <view wx:if="{{currentSubmission.images && currentSubmission.images.length > 0}}" class="preview-images">
          <scroll-view scroll-x class="image-scroll">
            <view class="image-list">
              <image 
                wx:for="{{currentSubmission.images}}" 
                wx:key="index"
                src="{{item}}" 
                mode="aspectFill"
                class="preview-image"
                bindtap="previewSubmittedImage"
                data-url="{{item}}"
                lazy-load="true"
                show-menu-by-longpress="false"
                binderror="onImageError"
              />
            </view>
          </scroll-view>
        </view>

        <!-- 文字内容 -->
        <view wx:if="{{currentSubmission.text}}" class="preview-text">
          <text>{{currentSubmission.text}}</text>
        </view>
      </view>

      <!-- 操作按钮 -->
      <view class="action-buttons">
        <button wx:if="{{submissionCount < 3 && canResubmit}}" class="resubmit-btn {{canResubmit ? '' : 'disabled'}}" disabled="{{!canResubmit}}" bindtap="resubmit">
          重新提交
        </button>
      </view>
    </view>
  </view>

  <!-- 视图3：已批改状态 -->
  <view wx:elif="{{viewType === 'reviewed'}}" class="reviewed-section">
    <!-- 批改结果标题 -->
    <view class="section-title">
      <text class="icon">✨</text>
      <text>批改结果</text>
    </view>

    <!-- 我的作业 -->
    <view class="my-work-card">
      <view class="work-title">
        <text class="icon">📝</text>
        <text>我的作业</text>
      </view>
      
      <!-- 图片展示 (小图片) -->
      <view wx:if="{{currentSubmission.images && currentSubmission.images.length > 0}}" class="work-images">
        <image 
          wx:for="{{currentSubmission.images}}" 
          wx:key="index"
          src="{{item}}" 
          mode="aspectFill"
          class="work-image-small"
          bindtap="previewSubmittedImage"
          data-url="{{item}}"
          lazy-load="true"
          show-menu-by-longpress="false"
          binderror="onImageError"
        />
      </view>

      <!-- 文字内容 -->
      <view wx:if="{{currentSubmission.text}}" class="work-text">
        <text>{{currentSubmission.text}}</text>
      </view>
    </view>

    <!-- 评分状态卡片 -->
    <view class="grade-status-card {{currentSubmission.grade}}">
      <view class="grade-badge">
        <text class="grade-icon">{{currentSubmission.grade === 'excellent' ? '💫' : currentSubmission.grade === 'good' ? '⭐' : '🔄'}}</text>
        <text class="grade-text">{{gradeTitle}}</text>
      </view>
      <text class="grade-description">{{gradeDesc}}</text>
    </view>

    <!-- 老师评语 -->
    <view wx:if="{{currentSubmission.comment}}" class="teacher-comment">
      <view class="comment-title">
        <text class="icon">💬</text>
        <text>老师评语</text>
      </view>
      <view class="comment-content">
        {{currentSubmission.comment}}
      </view>
    </view>

    <!-- 操作按钮 -->
    <view class="action-buttons">
      <!-- 复盘完成按钮 -->
      <button wx:if="{{fromReview}}" class="complete-review-btn primary" bindtap="completeReview">
        完成复盘
      </button>
      
      <!-- 重新提交按钮 -->
      <button wx:if="{{!fromReview && submissionCount < 3 && !task.is_ended && canResubmit}}" class="resubmit-btn outline {{canResubmit ? '' : 'disabled'}}" disabled="{{!canResubmit}}" bindtap="resubmit">
        重新提交
      </button>
    </view>
  </view>

</view>

<!-- 上传进度组件 -->
<upload-progress 
  show="{{showUploadProgress}}" 
  showSimple="{{showSimpleProgress}}"
  bind:close="onUploadProgressClose"
  bind:progressUpdate="onUploadProgressUpdate"
  bind:uploadSuccess="onUploadSuccess"
  bind:uploadError="onUploadError"
  bind:uploadCanceled="onUploadCanceled"
/>

<!-- 学生批改历史组件 -->
<grading-history 
  show="{{showMyGradingHistory}}"
  studentName="{{userInfo.nickname}}"
  taskId="{{taskId}}"
  studentId="{{userInfo.id}}"
  allowExport="{{false}}"
  bind:close="onMyGradingHistoryClose"
/>

<!-- 升级引导组件 -->
<upgrade-guide 
  show="{{showUpgradeGuide}}"
  guideType="{{upgradeGuideType}}"
  featureName="任务详情"
  bind:close="onUpgradeGuideClose"
/>

<!-- 试用限制提示组件 -->
<trial-restriction 
  show="{{showTrialRestriction}}"
  bind:close="onTrialRestrictionClose"
/>

<!-- 底部安全区域 -->
<view class="safe-bottom"></view>